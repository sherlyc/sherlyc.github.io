# New Relic Synthetics Test

##### Notes: Do not edit this file unless you intend to update the synthetics script running at our SPADE Homepage in New Relic:

https://synthetics.newrelic.com/accounts/1406710/monitors/454add9d-3b29-4fad-9bc9-25ce72d8f16a/script
Currently this will run every 5 minutes to check for elements on i.stuff.co.nz.

```javascript
const assert = require("assert");
const blackListed = [
  "https://somniture.stuff.co.nz",
  "https://fonts.googleapis.com",
  "https://assets.adobedtm.com"
];
$browser.addHostnamesToBlacklist(blackListed);
const getCssElement = (selector) => {
  console.log("getCssElement", selector);
  return $browser.waitForAndFindElement($driver.By.css(selector), 8000);
};

const selectMobileSite = async () => {
  const element = await getCssElement(".view-mobile-site");
  element.click();
};

const closeOLI = async () => {
  console.log("checking oli, closing it if found");
  try {
    const OliCloseBtn = await $browser.waitForAndFindElement(
      $driver.By.partialLinkText("close ad"),
      10000
    );
    return OliCloseBtn.click();
  } catch (e) {
    console.log("OLI was not found");
  }
};
const shouldContainHeader = async () => {
  console.log("checking header, no error means ok");
  const element = await getCssElement("app-header");
  return assert(element != null, "app-header element is null");
};
const shouldContainBasicAdUnit = async () => {
  const element = await getCssElement("app-basic-ad-unit[id] iframe");
  return assert(element != null, "no ad unit is found");
};
const shouldContainFooter = async () => {
  console.log("checking footer, no error means ok");
  const element = await getCssElement("app-footer");
  return assert(element != null, "footer element is null");
};

const shouldContainTopStoriesHighlights = async () => {
  console.log("checking top stories highlights");
  const homepageHighlights = await $browser.findElements(
    $driver.By.css(
      "app-grid-container:first-of-type app-homepage-highlight-article"
    )
  );
  const defcon = await $browser.findElements(
    $driver.By.css("app-grid-container:first-of-type app-defcon")
  );
  return assert(
    homepageHighlights.length === 2 || defcon.length === 1,
    "top stories highlights are not available"
  );
};

const shouldContainTopStoriesArticles = async () => {
  console.log("checking top stories articles");
  const homepageArticles = await $browser.findElements(
    $driver.By.css("app-grid-container:first-of-type app-homepage-article")
  );
  return assert(
    homepageArticles.length > 6,
    "top stories articles are not available"
  );
};

const shouldContainLatestHeadline = async () => {
  console.log("checking latest headlines");
  const latestHeadlineArticles = await $browser.findElements(
    $driver.By.css(
      "app-grid-container:first-of-type app-vertical-article-list a"
    )
  );
  return assert(
    latestHeadlineArticles.length > 5,
    "latest headlines articles are not available"
  );
};

const shouldContainImportantStraps = async () => {
  console.log("checking important straps");
  const importantStraps = await $browser.findElements(
    $driver.By.css("app-grid-container > div > div > app-module-header > div")
  );
  const strapsToCheck = ["editors' picks", "coronavirus", "national"];
  const strapHeaders = await Promise.all(
    importantStraps.map((strap) => strap.getText())
  );
  strapsToCheck.forEach((strap) => assert(strapHeaders.includes(strap)));
};

$browser
  .get("https://www.stuff.co.nz")
  .then(closeOLI)
  .then(shouldContainHeader)
  .then(shouldContainTopStoriesHighlights)
  .then(shouldContainTopStoriesArticles)
  .then(shouldContainLatestHeadline)
  .then(shouldContainImportantStraps)
  .then(shouldContainBasicAdUnit)
  .then(shouldContainFooter);
```
