<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title></title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="robots" content="noarchive" />
    <meta name="verify-v1" content="RazNiYjuvNuEsMeFXxfR9l9cDZIKxcq2VjQZA25CHgM=" />
    <script src="https://browser.sentry-cdn.com/5.11.0/bundle.min.js" integrity="sha384-jbFinqIbKkHNg+QL+yxB4VrBC0EAPTuaLGeRT0T+NfEV89YC6u1bKxHLwoo+/xxY" crossorigin="anonymous"></script>
    <script>
      Sentry.init({
        dsn: "https://4d85d50cd0ec418792cf6e031e460229@sentry.io/1425567",
        environment: ["i.stuff.co.nz", "www.stuff.co.nz"].indexOf(window.location.hostname) >= 0 ? "production" : undefined
      });
      Sentry.configureScope(function (scope) {
        scope.setLevel(Sentry.Severity.Debug);
        Sentry.captureMessage("Device needs to be updated", "debug");
      });

      var deviceId = window.localStorage.getItem("__storejs_stuff-experience_deviceId") || "";
      var uninstallSwKey = "spade-uninstall-sw";
      var search = window.location.search.split("?");
      if (search.length > 1) {
        var searchParams = search[1].split("&");
        var feVersion = searchParams[0];
        var beVersion = searchParams[1];
      }

      var count = window.localStorage.getItem(uninstallSwKey) || 0;
      var updatedCount = parseInt(count, 10) + 1;
      window.localStorage.setItem(uninstallSwKey, updatedCount);

      if (updatedCount > 1) {
        if ("serviceWorker" in navigator) {
          window.addEventListener("load", function () {
            navigator.serviceWorker.getRegistrations().then(function (registrations) {
              for (var index in registrations) {
                if (registrations.hasOwnProperty(index)) {
                  registrations[index]
                    .unregister()
                    .then(function () {
                      Sentry.configureScope(function (scope) {
                        scope.setTag("spade.deviceId", `${deviceId}`);
                        scope.setTag("spade.feVersion", `${feVersion}`);
                        scope.setTag("spade.beVersion", `${beVersion}`);
                        scope.setTag("spade.pwa.uninstallPageCount", `${updatedCount}`);
                        scope.setLevel(Sentry.Severity.Debug);
                        Sentry.captureMessage("ServiceWorker successfully unregistered", "debug");
                      });
                      window.localStorage.removeItem(uninstallSwKey);
                      caches.keys().then(function (keyList) {
                        return Promise.all(
                          keyList.map(function (key) {
                            return caches.delete(key);
                          })
                        );
                      });
                    })
                    .catch(function () {
                      Sentry.configureScope(function (scope) {
                        scope.setTag("spade.deviceId", `${deviceId}`);
                        scope.setTag("spade.feVersion", `${feVersion}`);
                        scope.setTag("spade.beVersion", `${beVersion}`);
                        scope.setTag("spade.pwa.uninstallPageCount", `${updatedCount}`);
                        scope.setLevel(Sentry.Severity.Debug);
                        Sentry.captureMessage("ServiceWorker failed to unregister", "debug");
                      });
                    });
                }
              }
            });
          });
        }
      }
    </script>
  </head>
  <body></body>
</html>
